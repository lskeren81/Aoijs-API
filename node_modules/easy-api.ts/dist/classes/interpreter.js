"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Interpreter=void 0;const tslib_1=require("tslib"),compiler_1=require("./compiler"),fs_1=tslib_1.__importDefault(require("fs"));class Interpreter{functions;compiler;routes;app;db;reverseReading;constructor(e,r,t,i){this.compiler=new compiler_1.Compiler(""),this.reverseReading=i,this.routes=r,this.functions=[],this.app=e,this.db=t,this.load(),this.compiler.set_functions(this.functions.map(function(e){return e.data.name}))}async resolve_fields(r){if(r){for(let e=0;e<r.func?.fields?.length;e++)r.func=await this.resolve_field(r,e);return r}}async resolve_field(e,r){if(e.func?.fields?.[r])for(const l of e.func.fields[r].overs){var t,i=e.interpreter.functions.find(e=>e.data.name==l.name);i&&(l.resolve_fields=this.resolve_fields,l.resolve_field=this.resolve_field,t={...e,func:l,code:e.func.fields[r].value},(i=await i.code(t))?.code)&&e.func?.inside&&e.func.fields&&(e.func.fields[r].value=i.code,e.func.inside=e.func.fields.map(e=>e.value).join(";"),e.func.total=`${e.func.name}[${e.func.inside}]`,e.break=t.break,e._=t._)}return e.func}async parse(e,r,t,i){if(e){this.compiler.set_code(e),this.compiler.match();var l={code:this.compiler.result||"",compiler:this.compiler,routes:this.routes,interpreter:this,app:this.app,_:i?._||{},break:i?.break||!1,func:null,req:r,res:t},e=Object.entries(this.compiler.matched);for(const n of this.reverseReading?e:e.reverse()){if(l.break)break;await this.run_function(n[1],l)}return l}}async run_function(r,e){var t=this.functions.find(e=>e.data.name==r.name);t&&(r.resolve_fields=this.resolve_fields,r.resolve_field=this.resolve_field,e.func=r,(t=await t.code(e))?.code)&&(e.code=t.code?.trim()||"")}addFunction(e){this.functions[this.functions.length]=e,this.compiler.functions.push(e.data.name),this.compiler.set_functions(this.compiler.functions)}getFunction(r){var e=this.functions.find(e=>e.data.name==r.name);return e?Object.assign({name:e.data.name},e.data.extra):null}load(){for(const r of fs_1.default.readdirSync(__dirname.replace("classes","functions"))){var e=require("../functions/"+r).data;e&&this.addFunction(e)}String.prototype.replaceLast=function(e,r){var t;return(e="string"==typeof e?e:(this.match(new RegExp(e.source,"g"))||[]).slice(-1)[0])&&-1!==(t=this.lastIndexOf(e))?""+this.slice(0,t)+r+this.slice(t+e.length):this},String.prototype.resolve=function(e,r){var t=this.split(e),i=t.pop();return t.join(e)+r+i},String.prototype.unescape=function(){return this.replaceAll("@at","@").replaceAll("@left","]").replaceAll("@right","[").replaceAll("@semi",";").replaceAll("@colon",":").replaceAll("@equal","=").replaceAll("@or","||").replaceAll("@and","&&").replaceAll("@higher",">").replaceAll("@lower","<").replaceAll("@left_parent",")").replaceAll("@right_parent","(")},String.prototype.escape=function(){return this.replaceAll("@","@at").replaceAll("]","@left").replaceAll("[","@right").replaceAll(";","@semi").replaceAll(":","@colon").replaceAll("=","@equal").replaceAll("||","@or").replaceAll("&&","@and").replaceAll(">","@higher").replaceAll("<","@lower")}}}exports.Interpreter=Interpreter;